name: Deploy to Azure

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_call:
    inputs:
      environment:
        type: string
        description: environment to deploy to
        required: true
  workflow_dispatch:
    inputs:
      force_feedback_ui:
        type: boolean
        description: Deploy feedback UI even if unchanged
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  detect-feedback-ui-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for feedback-ui changes
        id: check
        run: |
          if git diff --name-only HEAD~1 | grep -q '^feedback-ui/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

  build-api:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}
    outputs:
      image_tag: ${{ steps.vars.outputs.sha_short }}
    steps:
      - name: "Az CLI login"
        uses: azure/login@v2.1.0
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            backend

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure Docker Login
        id: acr_login
        uses: Azure/cli@v2.0.0
        with:
          inlineScript: |
            {
              echo "docker_token<<EOF"
              echo "$(az acr login -n ${{vars.REGISTRY_NAME}} --expose-token --output tsv --query accessToken)"
              echo "EOF"
            } >> $GITHUB_OUTPUT

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{vars.REGISTRY_NAME}}.azurecr.io
          username: 00000000-0000-0000-0000-000000000000
          password: ${{ steps.acr_login.outputs.docker_token }}

      - name: Set job env
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push API Docker image
        uses: docker/build-push-action@v5.1.0
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{vars.REGISTRY_NAME}}.azurecr.io/${{vars.APP_NAME}}:${{ steps.vars.outputs.sha_short }}

  build-frontend:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            frontend

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_BASE: ${{ vars.API_BASE_URL }}
          VITE_KEYCLOAK_URL: ${{ vars.KEYCLOAK_URL }}
          VITE_KEYCLOAK_REALM: ${{ vars.KEYCLOAK_REALM }}
          VITE_KEYCLOAK_CLIENT_ID: ${{ vars.KEYCLOAK_CLIENT_ID }}
        run: npm run build

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  build-feedback-ui:
    # Detect changes so we don't purge the cached application if it hasn't changed
    needs: detect-feedback-ui-changes
    if: needs.detect-feedback-ui-changes.outputs.changed == 'true' || inputs.force_feedback_ui == true
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            feedback-ui

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "npm"
          cache-dependency-path: feedback-ui/package-lock.json

      - name: Install dependencies
        working-directory: ./feedback-ui
        run: npm ci

      - name: Build feedback UI
        working-directory: ./feedback-ui
        env:
          VITE_API_BASE: ${{ vars.API_BASE_URL }}
          VITE_KEYCLOAK_URL: ${{ vars.KEYCLOAK_URL }}
          VITE_KEYCLOAK_REALM: ${{ vars.KEYCLOAK_REALM }}
          VITE_KEYCLOAK_CLIENT_ID: ${{ vars.KEYCLOAK_FEEDBACK_CLIENT_ID }}
          VITE_BASE: /feedback/
        run: npm run build

      - name: Upload feedback UI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: feedback-ui-dist
          path: feedback-ui/dist
          retention-days: 1

  deploy-api:
    runs-on: ubuntu-latest
    needs: build-api
    environment: ${{ inputs.environment || 'staging' }}
    steps:
      - name: "Az CLI login"
        uses: azure/login@v2.1.0
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy built image to API container app
        uses: Azure/container-apps-deploy-action@v1
        with:
          acrName: ${{vars.REGISTRY_NAME}}
          containerAppName: ${{vars.CONTAINER_APP_NAME}}
          resourceGroup: ${{vars.RESOURCE_GROUP}}
          containerAppEnvironment: ${{vars.CONTAINER_APP_ENV}}
          imageToDeploy: ${{vars.REGISTRY_NAME}}.azurecr.io/${{vars.APP_NAME}}:${{ needs.build-api.outputs.image_tag }}

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-frontend
    environment: ${{ inputs.environment || 'staging' }}
    steps:
      - name: "Az CLI login"
        uses: azure/login@v2.1.0
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist

      - name: Deploy frontend to blob storage
        uses: Azure/cli@v2.0.0
        with:
          inlineScript: |
            az storage blob upload-batch \
              --account-name ${{ vars.STORAGE_ACCOUNT_NAME }} \
              --destination '$web' \
              --source ./dist \
              --overwrite true

  deploy-feedback-ui:
    runs-on: ubuntu-latest
    needs: build-feedback-ui
    environment: ${{ inputs.environment || 'staging' }}
    steps:
      - name: "Az CLI login"
        uses: azure/login@v2.1.0
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Download feedback UI artifacts
        uses: actions/download-artifact@v4
        with:
          name: feedback-ui-dist
          path: dist

      - name: Deploy feedback UI to blob storage
        uses: Azure/cli@v2.0.0
        with:
          inlineScript: |
            az storage blob upload-batch \
              --account-name ${{ vars.FEEDBACK_STORAGE_ACCOUNT_NAME }} \
              --destination '$web' \
              --source ./dist \
              --overwrite true

      - name: Purge Front Door cache for feedback UI
        uses: Azure/cli@v2.0.0
        with:
          inlineScript: |
            az afd endpoint purge \
              --resource-group ${{ vars.RESOURCE_GROUP }} \
              --profile-name ${{ vars.FRONTDOOR_PROFILE_NAME }} \
              --endpoint-name ${{ vars.FRONTDOOR_ENDPOINT_NAME }} \
              --content-paths "/feedback/*"

  migrate-database:
    runs-on: ubuntu-latest
    needs: [deploy-api, build-api]
    environment: ${{ inputs.environment || 'staging' }}
    steps:
      - name: "Az CLI login"
        uses: azure/login@v2.1.0
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Update database migrator job image
        uses: Azure/cli@v2.0.0
        with:
          inlineScript: |
            az containerapp job update \
              --name "db-migrator-${{ vars.ENVIRONMENT_NAME }}" \
              --resource-group ${{vars.RESOURCE_GROUP}} \
              --image ${{vars.REGISTRY_NAME}}.azurecr.io/${{vars.APP_NAME}}:${{ needs.build-api.outputs.image_tag }}

      - name: Trigger database migrations
        uses: Azure/cli@v2.0.0
        with:
          inlineScript: |
            az containerapp job start \
              --name "db-migrator-${{ vars.ENVIRONMENT_NAME }}" \
              --resource-group ${{vars.RESOURCE_GROUP}}
